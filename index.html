<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Explore Swiss building data. Open, accessible, and designed for everyone.">
  <title>OpenBuildings.ch</title>

  <!-- Preconnect to external domains (do this FIRST for faster connections) -->
  <link rel="preconnect" href="https://unpkg.com">
  <link rel="preconnect" href="https://api.protomaps.com">
  <link rel="preconnect" href="https://cdn.jsdelivr.net">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://vectortiles.geo.admin.ch">

  <!-- MapLibre GL CSS -->
  <link href="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.css" rel="stylesheet">

  <!-- Fonts - display=swap already ensures text is visible immediately -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- Application CSS -->
  <link href="css/styles.css" rel="stylesheet">

  <!-- Scripts with defer - downloads in parallel, executes after HTML parsing -->
  <script defer src="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.js" crossorigin="anonymous"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" crossorigin="anonymous"></script>
  <script defer src="js/app.js"></script>
</head>
<body>
  <main>
    <div id="map"></div>

    <!-- Search overlay -->
    <div class="search-container">
      <div class="search-input-wrapper">
        <svg class="search-icon" viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="8"></circle>
          <path d="m21 21-4.35-4.35"></path>
        </svg>
        <input type="text" id="searchInput" placeholder="Search by address, EGID, or place..." autocomplete="off">
        <button class="search-clear" id="searchClear" type="button" aria-label="Clear search">×</button>
      </div>
      <div class="search-dropdown" id="searchDropdown">
        <div class="search-section" id="locationsSection">
          <div class="search-section-header">Locations</div>
          <div class="search-results" id="locationsResults"></div>
        </div>
        <div class="search-section" id="layersSection">
          <div class="search-section-header">Layers</div>
          <div class="search-results" id="layersResults"></div>
        </div>
      </div>
    </div>

    <!-- Custom Map Navigation -->
    <div class="map-nav">
      <button class="map-nav-btn" id="zoomInBtn" title="Zoom in" aria-label="Zoom in">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <line x1="12" y1="5" x2="12" y2="19"></line>
          <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
      </button>
      <button class="map-nav-btn" id="zoomOutBtn" title="Zoom out" aria-label="Zoom out">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
      </button>
      <div class="map-nav-divider"></div>
      <button class="map-nav-btn" id="compassBtn" title="Reset north" aria-label="Reset north">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polygon points="12,2 15,10 12,8 9,10" fill="currentColor" stroke="none"></polygon>
          <polygon points="12,22 9,14 12,16 15,14" fill="none"></polygon>
        </svg>
      </button>
      <button class="map-nav-btn" id="homeBtn" title="Reset view" aria-label="Reset view">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
          <polyline points="9 22 9 12 15 12 15 22"></polyline>
        </svg>
      </button>
      <button class="map-nav-btn" id="toggle3DBtn" title="Toggle 3D view" aria-label="Toggle 3D view">
        3D
      </button>
    </div>
    <div class="basemap-selector" id="basemapSelector">
      <div class="basemap-toggle light" id="basemapToggle"></div>
      <div class="basemap-options">
        <div class="basemap-option light active" data-style="white" data-label="White"></div>
        <div class="basemap-option streets" data-style="light" data-label="Light"></div>
        <div class="basemap-option outdoors" data-style="grayscale" data-label="Gray"></div>
        <div class="basemap-option satellite" data-style="dark" data-label="Dark"></div>
      </div>
    </div>

    <!-- Legend Accordion -->
    <div class="legend-accordion expanded" id="legendAccordion">
      <button class="legend-accordion-header" id="legendAccordionHeader" aria-expanded="true">
        <svg class="legend-icon" viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="3" y1="6" x2="21" y2="6"></line>
          <line x1="3" y1="12" x2="21" y2="12"></line>
          <line x1="3" y1="18" x2="21" y2="18"></line>
          <circle cx="7" cy="6" r="2" fill="currentColor"></circle>
          <circle cx="14" cy="12" r="2" fill="currentColor"></circle>
          <circle cx="10" cy="18" r="2" fill="currentColor"></circle>
        </svg>
        <span class="legend-accordion-title">Legende</span>
        <svg class="legend-chevron" viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="6 9 12 15 18 9"></polyline>
        </svg>
      </button>
      <div class="legend-accordion-content" id="legendAccordionContent">

      <!-- Buildings Layer Section -->
      <div class="legend-section" data-layer="buildings">
        <div class="legend-section-header">
          <span class="legend-section-title">Gebäude</span>
          <button class="legend-layer-toggle active" data-layer="buildings" title="Toggle layer visibility">
            <span class="toggle-dot"></span>
          </button>
        </div>
        <div class="legend-color-toggle" id="buildingColorToggle">
          <button class="legend-color-btn" data-building-color="none">Keine</button>
          <button class="legend-color-btn active" data-building-color="status">Status</button>
        </div>
        <div class="legend-section-content" id="buildingsLegendItems">
          <!-- Populated dynamically -->
        </div>
      </div>

      <!-- Landcovers Layer Section -->
      <div class="legend-section" data-layer="landcovers">
        <div class="legend-section-header">
          <span class="legend-section-title">Bodenbedeckung</span>
          <button class="legend-layer-toggle active" data-layer="landcovers" title="Toggle layer visibility">
            <span class="toggle-dot"></span>
          </button>
        </div>
        <div class="legend-color-toggle">
          <button class="legend-color-btn active" data-color="none">Keine</button>
          <button class="legend-color-btn" data-color="category">Kategorie</button>
          <button class="legend-color-btn" data-color="period">Periode</button>
        </div>
        <div class="legend-section-content" id="landcoversLegendItems">
          <!-- Populated dynamically -->
        </div>
      </div>

      <!-- Parcels Layer Section -->
      <div class="legend-section" data-layer="parcels">
        <div class="legend-section-header">
          <span class="legend-section-title">Parzellen</span>
          <button class="legend-layer-toggle active" data-layer="parcels" title="Toggle layer visibility">
            <span class="toggle-dot"></span>
          </button>
        </div>
        <div class="legend-section-content">
          <div class="legend-item">
            <span class="legend-swatch legend-swatch-outline" style="border-color: #1e3a5f"></span>
            <span class="legend-label">Parzelle</span>
          </div>
        </div>
      </div>
      </div>
    </div>
    <!-- Building Panel -->
    <aside class="building-panel" id="buildingPanel">
      <div class="building-panel-header">
        <div class="building-panel-title">
          <h2 id="panelBuildingName">Building Name</h2>
          <div class="location" id="panelBuildingLocation">Location</div>
        </div>
        <button class="building-panel-close" id="closePanelBtn" aria-label="Close panel">
          <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M18 6L6 18M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      <div class="building-panel-content">
        <div class="building-panel-metrics" id="panelMetrics">
          <!-- Metrics will be populated dynamically -->
        </div>
      </div>
      <div class="building-panel-footer">
        <button class="btn-primary" id="downloadReportBtn">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"></path>
          </svg>
          Download Report
        </button>
      </div>
    </aside>

    <!-- Map Scale Overlay -->
    <div class="map-scale-overlay" id="scaleContainer"></div>

    <!-- Map Context Menu (right-click) -->
    <div class="map-context-menu" id="mapContextMenu">
      <button class="context-menu-coords" id="contextMenuCoords">
        <span class="coords-text">47.35191, 8.49471</span>
        <svg class="copy-icon" viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
          <path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"></path>
        </svg>
      </button>
      <div class="context-menu-divider"></div>
      <button class="context-menu-item" id="contextMenuShare">
        <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="18" cy="5" r="3"></circle>
          <circle cx="6" cy="12" r="3"></circle>
          <circle cx="18" cy="19" r="3"></circle>
          <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line>
          <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line>
        </svg>
        Share this location
      </button>
      <button class="context-menu-item" id="contextMenuPrint">
        <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="6 9 6 2 18 2 18 9"></polyline>
          <path d="M6 18H4a2 2 0 01-2-2v-5a2 2 0 012-2h16a2 2 0 012 2v5a2 2 0 01-2 2h-2"></path>
          <rect x="6" y="14" width="12" height="8"></rect>
        </svg>
        Print
      </button>
      <div class="context-menu-divider"></div>
      <button class="context-menu-item" id="contextMenuMeasure" disabled>
        <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M2 12h2M6 12h2M10 12h2M14 12h2M18 12h2M22 12h2"></path>
          <line x1="2" y1="8" x2="2" y2="16"></line>
          <line x1="22" y1="8" x2="22" y2="16"></line>
        </svg>
        Measure distance
      </button>
      <button class="context-menu-item" id="contextMenuReport" disabled>
        <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"></path>
          <line x1="4" y1="22" x2="4" y2="15"></line>
        </svg>
        Report a data problem
      </button>
    </div>

    <div class="loading-overlay" id="loadingOverlay">
      <div class="loading-spinner"></div>
      <span style="margin-top: 12px; color: #64748b; font-size: 14px;">Loading map...</span>
    </div>
  </main>

  <!-- App Footer -->
  <footer class="app-footer" id="appFooter">
    <div class="app-footer-coords" id="mouseCoords">WGS 84 | Koordinaten: –</div>
    <div class="app-footer-links">
      <a href="https://github.com/davras5/OpenBuildings" target="_blank" rel="noopener">GitHub</a>
      <span class="app-footer-divider">·</span>
      <a href="https://awnypgafushbsvqlsjyg.supabase.co" target="_blank" rel="noopener">API</a>
    </div>
  </footer>

  <!-- Toast notifications container -->
  <div class="toast-container" id="toastContainer"></div>
</body>
</html>
